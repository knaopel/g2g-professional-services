{{: ~IncludeCSS("/Style%20Library/List%20Templates/staff-roles.css") }}
<div data-app-id="{{:AppId}}">
    <div id="pricing-window-{{:AppId}}" style="background-color: white; background-image: none;" data-role="popup" class="ui-content pricing-window"
        data-theme="a" data-overlay-theme="a"></div>
    <h2 class="mp-rteElement-H2">Staff Roles</h2>
    <p>The following Staff Roles were provided through the Oakland County Professional Services. The Staff Role is a general
        description. During the X process, more specific duties and technical environments will be presented to the professional
        service firms during the staff requisition process.</p>
    {{for Model ~AppId=AppId}}
    <div data-role="collapsible">
        <h4>{{:Title}}</h4>
        <p><strong>Role:</strong> {{:Role}}<br/><strong>Technical Environment(s):</strong> {{:TechnicalEnvironment}}</p>
        <a class="pricing-button" data-role="button" href="#pricing-window-{{:~AppId}}" data-id="{{:Id}}" data-transition="flip"
            data-rel="popup" data-position-to="window">Pricing</a>
    </div>
    {{/for}}
</div>
<script type="text/javascript">
    G2G.Apps.Runtime['{{AppEvent Init/}}'] = function () {
		var self = this;
        this.$AppContainer.enhanceWithin();
        var appId = this.PartInfo.StorageKey;
        var popId = '#pricing-window-' + appId;
        var $app = this.$AppContainer;
        var templateUrl = '/Style%20Library/List%20Templates/';
        
        $1_10_2.views.converters({
            currency: function (val) {
                return "$ " + parseFloat(val).toFixed(2);            
            }
        });
        
        var lazyGetTemplate = function (name) {
            var deferred = $1_10_2.Deferred();
            if ($1_10_2.templates[name]) {
                deferred.resolve();
            } else {
                G2G.Utilities.GetContent(templateUrl + name + '.tmpl.html', function (tmplMarkup) {
                    $1_10_2.templates(name, tmplMarkup);
                    deferred.resolve();
                });
            }
            return deferred.promise();
        };
        
        var populatePricing = function(roleId) {
        	var deferred = $1_10_2.Deferred();
            var apiUrl;
            if (roleId) {
                apiUrl = String.format("/professional-services/_api/Web/Lists/GetByTitle('Vendor Rates')/Items/?$Select=Role/Id,Role/Title,Vendor/Id,Vendor/Title,Vendor/FirstName,Vendor/LastName,Vendor/email,Vendor/Phone,Vendor/SecondaryPhone,Year1,Year2,Year3&$Expand=Role,Vendor&$Filter=Role/Id eq {0}", roleId);
            } else {
                apiUrl = "/professional-services/_api/Web/Lists/GetByTitle('Vendor Rates')/Items/?$Select=Role/Id,Role/Title,Vendor/Id,Vendor/Title,Vendor/FirstName,Vendor/LastName,Vendor/email,Vendor/Phone,Vendor/SecondaryPhone,Year1,Year2,Year3&$Expand=Role,Vendor&$Top=1"
            }
        	G2G.Utilities.spApiJson(
        		apiUrl,
        		function (data) {
        			$1_10_2.when(lazyGetTemplate('staff-role-pricing')).done( function () {
        				var markup = $1_10_2.render['staff-role-pricing'](data.d);
        				$1_10_2(popId).html(markup).enhanceWithin();
        				deferred.resolve();
        			});
        		}
        	);
        	return deferred;
        };
        
        var pricingPop = function (evt) {
            var $target = $1_10_2(evt.target);
            var roleId = $target.attr('data-id');
            
            populatePricing(roleId).then(function () {            
	            $1_10_2(popId).popup('open', { positionTo: 'window' });
	        });
        };

        populatePricing(data.d.results[0].Id);
        
        this.$AppContainer.find('.pricing-button').click(pricingPop);
    }
</script>